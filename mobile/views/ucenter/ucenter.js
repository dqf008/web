angular.module("ionicz.controllers").controller("UCenterBaseCtrl",["$scope","Tools",function(a,b){a.back=b.back("/ucenter/index")}]).controller("UCenterCtrl",["$scope","$rootScope","$timeout","$state","$ionicPopup","$location","Tools","md5","My",function(a,b,c,d,e,f,g,h,i){a.$on("$ionicView.beforeEnter",function(){i.refreshMoney(!1)}),a.goPageCheckFundPwd=function(b){a.checkFundPwd()&&d.go(b)},a.checkFundPwd=function(){return UCenter.checkFundPwd()},a.addFullName=function(){i.getFullName()?g.alert("您已经添加了真实姓名"):g.modal({templateUrl:"fullname-template",title:"添加真实名字",callback:function(a,b){var c=a.modalData.fullname;switch(!0){case!c:g.tip("请输入真实姓名");break;case!(/^[a-zA-Z ]{1,20}$/.test(c)||/^[\u4e00-\u9fa5]{1,10}$/.test(c)):g.tip("真实姓名格式不正确");break;default:g.ajax({method:"POST",params:{action:"setFullName",fullName:c},url:"ajax.php",success:function(a){a&&1==a.status?(g.tip("保存成功"),i.setFullName(c),b.close()):g.tip(a.msg)}})}return!1}})},a.showEmailModel=function(){UCenter.addEmail()}}]).controller("PwdCtroller",["$scope","$timeout","$ionicModal","$state","$location","Tools","My",function(a,b,c,d,e,f,g){a.type=e.search().fund?1:0,a.mdfLoginPwdData={},a.updatePwd=function(){return a.mdfLoginPwdData.OldLoginPwd==a.mdfLoginPwdData.NewLoginPwdRpt?(f.tip("新密码与旧密码不能相同"),void 0):(f.ajax({method:"POST",params:{action:"loginPwd",oldPwd:a.mdfLoginPwdData.OldLoginPwd,newPwd:a.mdfLoginPwdData.NewLoginPwdRpt},url:"ajax.php",success:function(a){return 1!=a.status?(f.tip(a.msg),!1):(f.tip("修改登录密码成功"),d.go("ucenter.index"),void 0)}}),void 0)},a.mdfFundPwdData={},a.updateFundPwd=function(){return g.hasFundPwd()&&a.mdfFundPwdData.OldFundPwd==a.mdfFundPwdData.NewFundPwdRpt?(f.tip("新密码与旧密码不能相同"),void 0):(f.ajax({method:"POST",params:{action:"fundPwd",oldPwd:a.mdfFundPwdData.OldFundPwd,newPwd:a.mdfFundPwdData.NewFundPwd},url:"ajax.php",success:function(a){return 1!=a.status?(f.tip(a.msg),!1):(f.tip(g.hasFundPwd()?"修改取款密码成功":"设置取款密码成功"),g.setHasFundPwd(!0),d.go("ucenter.index"),void 0)}}),void 0)},a.onChange=function(){}}]).controller("NoticeCtroller",["$rootScope","$scope","$timeout","$ionicModal","$location","Tools","My",function(a,b,c,d,e,f,g){var h=10,i=["web","sports","sms"];b.page=b.page||[],b.noticeList=b.noticeList||[],b.canLoadMore=b.canLoadMore||[],b.loadingMore=b.loadingMore||[],b.type=function(a){for(var b=0;b<i.length;b++)if(i[b]==a)return b;return 0}(e.search().type||"web"),b.noticeRefresh=function(){b.noticeList[b.type]=null,b.canLoadMore[b.type]=!0,b.page[b.type]=1,b.loadMore(!0)},b.loadMore=function(a){b.canLoadMore[b.type]&&(b.canLoadMore[b.type]=!1,angular.isUndefined(b.loadingMore[b.type])||(b.loadingMore[b.type]=!0),f.ajax({method:"POST",params:{action:"notice",type:i[b.type],page:b.page[b.type],rows:h},url:"ajax.php",success:function(d){d&&1==d.status&&d.totalCount>0?(b.noticeList[b.type]=b.noticeList[b.type]||[],b.noticeList[b.type]=b.noticeList[b.type].concat(d.msg),h*b.page[b.type]<d.totalCount&&(b.page[b.type]++,c(function(){b.canLoadMore[b.type]=!0},1e3))):b.noticeList[b.type]=[],b.loadingMore[b.type]=!1,b.$broadcast("scroll.infiniteScrollComplete"),a&&b.$broadcast("scroll.refreshComplete")}})),a||b.$broadcast("scroll.infiniteScrollComplete")},b.showDetail=function(a){f.modal({scope:b,title:b.noticeList[b.type][a].title,template:b.noticeList[b.type][a].content})},b.showSMSDetail=function(a){var c=function(){f.modal({scope:b,title:b.noticeList[b.type][a].title,template:b.noticeList[b.type][a].content,cancelText:"已读",okText:"删除",callback:function(c,d){f.ajax({method:"POST",params:{action:"sms",type:"delete",id:b.noticeList[b.type][a].id},backdrop:!0,url:"ajax.php",success:function(c){c&&1==c.status?b.noticeList[b.type].splice(a,1):f.tip("删除失败")}}),d.close()}})};b.noticeList[b.type][a].read?c():f.ajax({method:"POST",params:{action:"sms",type:"read",id:b.noticeList[b.type][a].id},url:"ajax.php",backdrop:!0,success:function(d){d&&1==d.status&&(g.userMsg--,b.noticeList[b.type][a].read=1,c())}})},b.deleteSMS=function(){f.confirm("确定要删除全部站内消息？",function(){f.ajax({method:"POST",params:{action:"sms",type:"clear"},url:"ajax.php",backdrop:!0,success:function(a){a&&1==a.status?(g.userMsg=0,f.tip("已删除全部站内消息"),b.noticeRefresh()):f.tip(a.msg)}})})},b.onChange=function(a){b.type=a,angular.isUndefined(b.noticeList[b.type])&&b.noticeRefresh()},b.onChange(b.type)}]).controller("TransferCtroller",["$scope","$timeout","$ionicModal","$state","$location","$filter","Tools","My",function(a,b,c,d,e,f,g){a.allowed=!0,a.watchCount=0,a.allCount=-1,a.mainIndex=-1,a.amountList=["全部",100,500,1e3,5e3,1e4],a.walletList={},a.errorMessage=[],a.transerModel={classLoading:0,colSpan:0,haveMoney:0},a.$on("$ionicView.beforeEnter",function(){g.ajax({method:"POST",params:{action:"transfer",type:"check"},url:"ajax.php",backdrop:!0,success:function(b){b&&1==b.status?(a.allowed=b.msg.allowed,a.walletList=b.msg.list,angular.forEach(b.msg.list,function(b){a.transerModel.colSpan+=b.colSpan}),a.transerModel.colSpan=a.transerModel.colSpan%3,a.refresh(!0)):g.tip(b.msg)}})}),a.refresh=function(b,c){a.transerModel.classLoading=1,a.clearSelect(),angular.forEach(a.walletList,function(a){var d=function(){g.ajax({method:"GET",params:{type:a.GameClassID},url:a.LiveMoneyUrl?a.LiveMoneyUrl:"../cj/live/live_money.php",success:function(b){b=b.match(/\((.+)\)/),b=angular.fromJson(b[1]),b&&"ok"==b.info?(a.LoadingState=a.State-1,a.walletBalance=b.msg):(a.LoadingState=2,a.walletBalance=0)}})};(b||1!=a.LoadingState&&(!c||c.indexOf(a.GameClassID)>=0))&&(a.LoadingState=1,b||"SYSTEM"==a.GameClassID||0==a.State?(a.State=1,g.ajax({method:"POST",params:{action:"transfer",type:"refresh",id:a.GameClassID},url:"ajax.php",success:function(c){c&&1==c.status?(a.State=c.msg.State,a.IsOnline=c.msg.IsOnline,a.OpenState=c.msg.OpenState,b||"SYSTEM"==a.GameClassID||1!=c.msg.State?(a.LoadingState=c.msg.State-1,a.walletBalance=c.msg.walletBalance):d()):(a.LoadingState=2,a.walletBalance=0)}})):d())}),a.transerModel.classLoading=0},a.chooseWalletFun=function(b){var c=a.walletList[b];a.transerModel.moneyIndex=null,a.transerModel.actualMoney=null,a.transerModel.walletType==c.GameClassID?(a.transerModel.walletType=null,a.transerModel.haveMoney=0):a.transerModel.rollInWallet!=c.GameClassID&&c.walletBalance>0&&1==c.State&&0==c.LoadingState&&(a.transerModel.walletType=c.GameClassID,a.transerModel.haveMoney=c.walletBalance)},a.rollInFun=function(b){var c=a.walletList[b];a.transerModel.rollInWallet==c.GameClassID?a.transerModel.rollInWallet=null:a.transerModel.walletType!=c.GameClassID&&1==c.State&&0==c.LoadingState&&(a.transerModel.rollInWallet=c.GameClassID)},a.chooseMoneyFun=function(b){a.transerModel.moneyIndex==b?(a.transerModel.moneyIndex=null,a.transerModel.actualMoney=null):(0==b||a.transerModel.haveMoney>=a.amountList[b])&&(a.transerModel.moneyIndex=b,a.transerModel.actualMoney=f("number")(0==b?a.transerModel.haveMoney:a.amountList[b]))},a.clearSelect=function(){a.transerModel.haveMoney=0,a.transerModel.walletType=null,a.transerModel.rollInWallet=null,a.transerModel.moneyIndex=null,a.transerModel.actualMoney=null},a.parseIntMoney=function(){a.transerModel.moneyIndex=null,a.transerModel.actualMoney=f("number")(a.transerModel.actualMoney),a.transerModel.actualMoney>a.transerModel.haveMoney&&(a.transerModel.actualMoney=f("number")(a.transerModel.haveMoney))},a.transferSubmit=function(){switch(!0){case!a.transerModel.walletType:g.tip("请选择转出钱包");break;case!a.transerModel.rollInWallet:g.tip("请选择转入钱包");break;case a.transerModel.walletType==a.transerModel.rollInWallet:g.tip("不能选择相同的钱包进行转账");break;case!a.transerModel.actualMoney:g.tip("请填写转账金额");break;case a.transerModel.actualMoney>a.transerModel.haveMoney:g.tip("转出钱包额度不足");break;default:g.ajax({method:"POST",params:{action:"transfer",type:"start",out:a.transerModel.walletType,"in":a.transerModel.rollInWallet,money:a.transerModel.actualMoney},url:"ajax.php",backdrop:!0,success:function(b){b&&1==b.status?(g.alert("转账完成"),a.refresh(0,[a.transerModel.walletType,a.transerModel.rollInWallet])):g.alert(["转账失败",b.msg])}})}},a.allIn=function(b){0==a.watchCount&&-1==a.allCount?g.confirm("确定全部转入"+a.walletList[b].GameClassName+"？",function(){a.allCount+=a.walletList.length,a.mainIndex=b,angular.forEach(a.walletList,function(c,d){c.TransferLoading=1,d>0&&d!=b&&g.ajax({method:"POST",params:{action:"transfer",type:"start",out:c.GameClassID,"in":"SYSTEM",money:"all"},url:"ajax.php",success:function(b){a.watchCount++,b&&1==b.status?c.TransferLoading=0:(a.errorMessage[d]=b.msg,c.TransferLoading=2)}})})}):a.watchCount==a.allCount&&(0==a.walletList[b].TransferLoading?g.alert("操作成功"):a.showError(b))},a.showError=function(b){g.alert(["转账失败",angular.isUndefined(a.errorMessage[b])?"发生未知错误":a.errorMessage[b]])},a.$watch("watchCount",function(b){0==a.mainIndex&&b==a.allCount?(a.walletList[0].TransferLoading=0,a.refresh()):a.mainIndex>0&&b==a.allCount-1&&g.ajax({method:"POST",params:{action:"transfer",type:"start",out:"SYSTEM","in":a.walletList[a.mainIndex].GameClassID,money:"all"},url:"ajax.php",success:function(b){a.walletList[0].TransferLoading=0,a.watchCount++,b&&1==b.status?a.walletList[a.mainIndex].TransferLoading=0:(a.errorMessage[a.mainIndex]=b.msg,a.walletList[a.mainIndex].TransferLoading=2),a.refresh()}})})}]);